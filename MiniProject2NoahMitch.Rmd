---
title: "MiniProject2NoahMitch"
format:
  pdf: default
editor_options: 
  chunk_output_type: console
---

```{r}
library(tidyverse)
library(stringr)
library(rvest)
library(polite)
library(sf)
library(maps)
library(viridis)
library(leaflet)
library(htmltools)
library(readr)
library(janitor)
```

Website Homepage: https://www.basketball-reference.com

Example Player Page: https://www.basketball-reference.com/players/e/edwaran01.html

Example Team Page: https://www.basketball-reference.com/teams/MIN/2025.html

*Checking that Scrapping is Allowed*

```{r}
robotstxt::paths_allowed("https://www.basketball-reference.com/players/e/edwaran01.html")

robotstxt::paths_allowed("https://www.basketball-reference.com/teams/MIN/2025.html")
```

*Player URL Setup*

Since players have their own unique identifier for URL, values have to be hand taken from a player's page's URL. For the sake of time, we only took the identifiers of the top 5 players based on average Minutes Per Game from each team. If a player had already been taken from another team and appears again in the top 5 of another, we took the next best performing player from that team as well. This leads to 250 total players to be examined.

```{r}
#top 5 players per team based on highest minutes per game average

player_url <- c("l/lavinza01", "f/foxde01", "d/derozde01", "s/sabondo01", "m/murrake02",  #kings players
                "b/bookede01", "d/duranke01", "b/bealbr01", "j/jonesty01", "o/onealro01", #suns players
                "h/hardeja01", "l/leonaka01", "z/zubaciv01", "p/powelno01", "b/bogdabo01", #clippers players
                "b/butleji01", "c/curryst01", "w/wiggian01", "g/greendr01", "p/podzibr01", #warriors players
                "d/doncilu01", "r/reaveau01", "j/jamesle01", "d/davisan02", "h/hachiru01", #lakers players
                "g/gilgesh01", "w/willija06", "d/dortlu01", "h/harteis01", "w/wallaca01", #thunder players
                "j/jokicni01", "m/murraja01", "b/braunch01", "p/portemi01", "g/gordoaa01", #nuggets players
                "c/camarto01", "s/simonan01", "g/grantje01", "s/sharpsh01", "a/aytonde01", #trailblazers players
                "e/edwaran01", "r/randlju01", "g/goberru01", "m/mcdanja02", "r/reidna01", #timberwolves players
                "g/georgke01", "m/markkla01", "c/collijo01", "k/kesslwa01", "s/sextoco01", #jazz players
                "v/vanvlfr01", "g/greenja05", "t/thompam01", "b/brookdi01", "s/sengual01", #rockets players
                "w/wembavi01", "v/vassede01", "p/paulch01", "b/barneha02", "c/castlst01", #spurs players
                "b/banede01", "m/moranja01", "j/jacksja02", "w/wellsja01", "a/aldamsa01", #grizzlies players
                "m/murphtr02", "i/ingrabr01", "m/mccolcj01", "m/murrade01", "j/joneshe01", #pelicans players
                "i/irvinky01", "w/washipj01", "c/chrisma02", "m/marshna01", "t/thompkl01", #mavericks players
                "m/maxeyty01", "o/oubreke01", "g/grimequ01", "g/georgpa01", "m/martica02", #76ers players
                "h/hartjo01", "b/bridgmi01", "a/anunoog01", "b/brunsja01", "t/townska01", #knicks players
                "b/barnesc01", "b/barrerj01", "p/poeltja01", "d/dickgr01", "q/quickim01", #raptors players
                "t/tatumja01", "b/brownja02", "w/whitede01", "h/holidjr01", "p/porzikr01", #celtics players
                "s/schrode01", "j/johnsca02", "t/thomaca02", "f/finnedo01", "t/timmedr01", #nets players
                "w/whiteco01", "v/vucevni01", "d/dosunay01", "g/giddejo01", "h/huertke01", #bulls players
                "c/cunnica01", "h/harrito02", "i/iveyja01", "h/hardati02", "b/beaslma01", #pistons players
                "m/mitchdo01", "g/garlada01", "m/mobleev01", "a/allenja01", "s/strusma01", #cavaliers players
                "l/lillada01", "k/kuzmaky01", "a/antetgi01", "l/lopezbr01", "p/princta02", #bucks players
                "h/halibty01", "s/siakapa01", "t/turnemy01", "m/mathube01", "n/nembhan01", #pacers players
                "h/herroty01", "a/adebaba01", "m/mitchda01", "r/roziete01", "j/jovicni01", #heat players
                "y/youngtr01", "j/johnsja05", "d/daniedy01", "h/huntede01", "o/okongon01", #hawks players
                "m/millebr02", "b/ballla01", "b/bridgmi02", "w/willigr01", "g/greenjo02", #hornets players
                "b/banchpa01", "w/wagnefr01", "c/caldwke01", "s/suggsja01", "c/cartewe01", #magic players
                "c/coulibi01", "c/carrica01", "p/poolejo01", "s/sarral01", "j/johnsaj01") #wizards players
```

*Scrapping using table and webpage based data (html_text and html_table)*

```{r}
seasonstat <- tibble() #fresh empty tibble that is ready to be added to

for(i in 1:150) { #loop for 150 players in player_url
  Sys.sleep(5) #Basketball reference has a limit on requests a minute so 5 seconds prevents from getting IP banned THIS TAKES AROUND 13 MINUTES
  url <- str_c("https://www.basketball-reference.com/players/", player_url[i], ".html")
  bow(url, force = TRUE) #announce and ask for permission to scrape
  map <- read_html(url)
  player_nodes <- html_nodes(map, "span")
  player_names <- html_text(player_nodes) #html text containing player's name
  last5_check <- html_nodes(map, "h2")
  last5 <- html_text(last5_check) #html text containing if a player has a last 5 games table title
  tables2 <- html_nodes(map, css = "table") 
  if (last5[[1]] == "Last 5 Games") { #checks if player has last 5 games table
  table2 <- html_table(tables2, header = TRUE, fill = TRUE)[[3]] |> #table of season averages
  filter(Season == "2024-25") |>
  mutate(Player = player_names[[9]]) #player's name is 9th in vector
  seasonstat <- rbind(seasonstat, table2) #adds to out season stats table
  } else { #players with no last 5 games table
table2 <- html_table(tables2, header = TRUE, fill = TRUE)[[2]] |>
  filter(Season == "2024-25") |>
  mutate(Player = player_names[[9]])
  seasonstat <- rbind(seasonstat, table2)
  }
}
```

*Backing Up File*

```{r}
write_csv(seasonstat, "~/sds264proj/seasonstat.csv")
```

*Cleaning Our Data Set*

```{r}
season25 <- seasonstat |>
  select(-Lg, -Awards, -Season) |>
  clean_names() |>
  filter(team != "2TM") |>
  rename(position = pos, games_played = g, games_started = gs, minutes_played = mp, field_goals = fg, field_goal_attempts = fga, field_goal_percent = fg_percent, three_point_makes = x3p, three_point_attempts = x3pa, three_point_percent = x3p_percent, two_point_makes = x2p, two_point_attempts = x2pa, two_point_percent = x2p_percent, expected_field_goal_percent = e_fg_percent, free_throw_makes = ft, free_throw_attempts = fta, free_throw_percent = ft_percent, offensive_rebounds = orb, defensive_rebounds = drb, total_rebounds = trb, assists = ast, steals = stl, blocks = blk, turnovers = tov, personal_fouls = pf, points = pts)
```

*Saving Data Set*

```{r}
write_csv(season25, "~/sds264proj/season25.csv")
```

